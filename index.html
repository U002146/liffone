<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸€éµå«è»Šæœå‹™</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            overflow: hidden; /* é˜²æ­¢æ•´é«”æ²å‹•ï¼Œè®“åœ°åœ–æ»¿ç‰ˆ */
            background-color: #f3f4f6;
        }

        /* --- åœ°åœ–å±¤ (Step 1) --- */
        #map-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            transition: transform 0.4s ease-in-out;
        }
        
        /* ç•¶é€²å…¥æ­¥é©Ÿ 2 æ™‚ï¼Œåœ°åœ–ä¸éœ€è¦è®Šæš—ï¼Œè€Œæ˜¯ç›´æ¥è¢«è¡¨å–®è“‹éæˆ–æ»‘èµ° */
        /* é€™è£¡æˆ‘å€‘é¸æ“‡è®“è¡¨å–®å¾ä¸‹æ–¹æ»‘ä¸Šä¾†è¦†è“‹ï¼Œé«”é©—æ¯”è¼ƒé †æš¢ */

        .center-marker {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -100%);
            z-index: 10;
            pointer-events: none;
            transition: all 0.2s ease;
        }
        .center-marker.lifting {
            transform: translate(-50%, -130%);
        }

        /* --- è¡¨å–®å±¤ (Step 2) --- */
        #form-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f9fafb; /* Gray-50 */
            z-index: 20;
            transform: translateY(100%); /* é è¨­éš±è—åœ¨ä¸‹æ–¹ */
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            flex-direction: column;
        }
        #form-layer.active {
            transform: translateY(0);
        }

        /* åº•éƒ¨æ§åˆ¶æ¿ (Step 1) */
        .bottom-panel-step1 {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 24px 24px 0 0;
            padding: 24px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            z-index: 15;
            transition: transform 0.3s ease;
        }
        .bottom-panel-step1.hidden-panel {
            transform: translateY(100%);
        }

        /* Google Autocomplete Style Fix */
        .pac-container {
            font-family: 'Noto Sans TC', sans-serif;
            border-radius: 8px;
            margin-top: 2px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            z-index: 9999 !important; /* ç¢ºä¿æµ®åœ¨æœ€ä¸Šå±¤ */
        }
        .pac-item {
            padding: 10px;
            font-size: 16px;
            cursor: pointer;
        }
        .pac-icon {
            display: none; /* éš±è—é è¨­ icon è®“ç•«é¢æ›´ä¹¾æ·¨ */
        }

        /* Payment Buttons */
        .payment-btn {
            transition: all 0.2s;
        }
        .payment-btn.active {
            border-color: #10B981;
            background-color: #ECFDF5;
            color: #059669;
            box-shadow: 0 0 0 1px #10B981;
        }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden">

    <!-- Loading Overlay -->
    <div id="loading" class="absolute inset-0 bg-white z-50 flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600 mb-4"></div>
        <p class="text-gray-500 font-medium animate-pulse">ç³»çµ±é€£ç·šä¸­...</p>
    </div>

    <!-- ========= STEP 1: åœ°åœ–é¸é» ========= -->
    
    <div id="map-layer">
        <div id="map" class="w-full h-full"></div>
    </div>

    <!-- ä¸­å¿ƒå¤§é ­é‡ -->
    <div id="center-marker" class="center-marker flex flex-col items-center justify-center">
        <div class="bg-black/80 text-white text-xs font-bold px-3 py-1.5 rounded-full mb-2 shadow-lg backdrop-blur-sm">
            ç§»å‹•åœ°åœ–ä¾†å®šä½
        </div>
        <i class="fa-solid fa-location-dot text-5xl text-emerald-600 drop-shadow-xl"></i>
        <div class="w-4 h-1.5 bg-black/20 rounded-full mt-1 blur-[1.5px]"></div>
    </div>

    <!-- Step 1 åº•éƒ¨é¢æ¿ -->
    <div id="bottom-panel-step1" class="bottom-panel-step1">
        <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-4"></div>
        
        <div class="text-center mb-6">
            <p class="text-xs font-bold text-emerald-600 uppercase tracking-wider mb-1">
                <i class="fa-solid fa-crosshairs mr-1"></i>ä¸Šè»Šåœ°é»
            </p>
            <h2 id="address-text-step1" class="text-xl font-bold text-gray-800 leading-snug min-h-[3.5rem] flex items-center justify-center">
                <span class="animate-pulse text-gray-400">å®šä½ä¸­...</span>
            </h2>
        </div>

        <button id="btn-confirm-pickup" onclick="goToStep2()" class="w-full bg-emerald-600 text-white font-bold py-4 rounded-xl shadow-lg active:scale-[0.98] transition-transform text-lg flex items-center justify-center space-x-2">
            <span>ç¢ºèªä¸Šè»Šåœ°é»</span>
            <i class="fa-solid fa-arrow-right"></i>
        </button>
    </div>

    <!-- æµ®å‹•å®šä½æŒ‰éˆ• -->
    <button id="my-loc-btn" onclick="panToCurrentLocation()" class="absolute bottom-64 right-4 bg-white p-3.5 rounded-full shadow-lg z-10 text-gray-600 active:bg-gray-100 transition-colors">
        <i class="fa-solid fa-location-crosshairs text-xl"></i>
    </button>


    <!-- ========= STEP 2: é ç´„è¡¨å–® (ä»¿ç…§ä½ çš„é ç´„ç³»çµ±) ========= -->

    <div id="form-layer" class="overflow-y-auto">
        <!-- Header -->
        <div class="bg-white px-5 py-4 shadow-sm border-b border-gray-100 flex items-center sticky top-0 z-30">
            <button onclick="backToMap()" class="w-8 h-8 flex items-center justify-center rounded-full active:bg-gray-100 mr-2 text-gray-500">
                <i class="fa-solid fa-chevron-left text-lg"></i>
            </button>
            <h1 class="text-lg font-bold text-gray-800 flex-1 text-center pr-8">é ç´„å«è»Š</h1>
        </div>

        <div class="p-5 space-y-5 pb-32">
            
            <!-- è¯çµ¡é›»è©± -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <label class="block text-gray-500 text-sm font-bold mb-2">
                    <i class="fa-solid fa-phone mr-1.5"></i>è¯çµ¡é›»è©±
                </label>
                <input type="tel" id="user-phone" placeholder="è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼" 
                    class="w-full text-xl font-bold text-gray-800 placeholder-gray-300 border-b-2 border-gray-100 focus:border-emerald-500 outline-none py-2 bg-transparent transition-colors">
            </div>

            <!-- æ™‚é–“ (One-Click é è¨­ç«‹å³) -->
            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 flex items-center space-x-3">
                <div class="bg-blue-100 w-10 h-10 rounded-full flex items-center justify-center text-blue-600">
                    <i class="fa-solid fa-clock"></i>
                </div>
                <div>
                    <p class="text-xs text-blue-600 font-bold">é ç´„æ™‚é–“</p>
                    <p class="text-base font-bold text-blue-900">ç«‹å³å‡ºç™¼ (VIP)</p>
                </div>
            </div>

            <!-- åœ°é»å€å¡Š -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 space-y-4">
                
                <!-- ä¸Šè»Š (å”¯è®€ï¼Œä¾†è‡ªåœ°åœ–) -->
                <div>
                    <label class="block text-xs font-bold text-emerald-600 mb-1">
                        <i class="fa-solid fa-circle text-[8px] mr-1 align-middle"></i>ä¸Šè»Šåœ°é»
                    </label>
                    <div class="flex items-start">
                        <div id="form-pickup-addr" class="text-base font-bold text-gray-800 break-words flex-1">
                            å°šæœªå®šä½
                        </div>
                        <button onclick="backToMap()" class="ml-2 text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded hover:bg-gray-200 whitespace-nowrap">
                            é‡é¸
                        </button>
                    </div>
                </div>

                <div class="border-t border-gray-100"></div>

                <!-- ä¸‹è»Š (é—œéµå­—æœå°‹) -->
                <div class="relative">
                    <label class="block text-xs font-bold text-red-500 mb-1">
                        <i class="fa-solid fa-circle text-[8px] mr-1 align-middle"></i>ä¸‹è»Šåœ°é»
                    </label>
                    <input type="text" id="dropoff-input" placeholder="è«‹è¼¸å…¥åœ°é»é—œéµå­— (å¦‚: å°åŒ—è»Šç«™)" 
                        class="w-full text-lg font-bold text-gray-800 placeholder-gray-300 border border-gray-200 rounded-lg px-3 py-2 focus:border-red-500 focus:ring-1 focus:ring-red-500 outline-none transition-all">
                    <!-- å¿«é€Ÿæ¸…é™¤æŒ‰éˆ• (é ç•™) -->
                </div>
            </div>

            <!-- ä»˜æ¬¾æ–¹å¼ -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <label class="block text-gray-500 text-sm font-bold mb-3">
                    <i class="fa-solid fa-wallet mr-1.5"></i>ä»˜æ¬¾æ–¹å¼
                </label>
                <div class="grid grid-cols-2 gap-3" id="payment-options">
                    <!-- JS ç”Ÿæˆ -->
                </div>
            </div>

        </div>

        <!-- åº•éƒ¨ç¢ºèªæŒ‰éˆ• -->
        <div class="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-gray-100 z-40 safe-area-bottom">
            <button onclick="submitOrder()" class="w-full bg-black text-white font-bold py-4 rounded-xl shadow-lg active:scale-[0.98] transition-transform text-xl flex items-center justify-center space-x-2">
                <i class="fa-solid fa-taxi"></i>
                <span>ç¢ºèªé ç´„</span>
            </button>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // âš ï¸ è¨­å®šå€ï¼šè«‹å†æ¬¡å¡«å…¥ API KEY
        const GOOGLE_MAPS_API_KEY = 'AIzaSyAKIajmzzSO7DHAhvLRMAh3iV-VVUA7cwE'; 
        const LIFF_ID = '2008907691-lqyPtbIY'; 

        // ä»˜æ¬¾æ–¹å¼è³‡æ–™ (å®Œå…¨ä¾ç…§ä½ çš„éœ€æ±‚)
        const PAYMENT_METHODS = [
            { id: 'cash', label: 'ç¾é‡‘', icon: 'fa-coins', color: 'text-gray-600' },
            { id: 'senior', label: 'æ•¬è€å¡', sub: '(65æ­²+)', icon: 'fa-person-cane', color: 'text-orange-500' },
            { id: 'disability', label: 'æ„›å¿ƒå¡', sub: '(èº«éšœ)', icon: 'fa-heart', color: 'text-red-500' },
            { id: 'coupon', label: 'ä¹˜è»Šåˆ¸', icon: 'fa-ticket', color: 'text-blue-500' },
            { id: 'twrq', label: 'TWRQ', icon: 'fa-qrcode', color: 'text-purple-500' },
            { id: 'linepay', label: 'LINE Pay', icon: 'fa-brands fa-line', color: 'text-green-500' },
            { id: 'applepay', label: 'Apple Pay', icon: 'fa-brands fa-apple', color: 'text-black' }
        ];

        let map;
        let geocoder;
        let autocomplete;
        let pickupLocation = { lat: null, lng: null, address: 'å®šä½ä¸­...' };
        let dropoffLocation = { address: '' };
        let selectedPayment = 'cash';
        
        // --- é å…ˆæŠ“å– GPS (åŠ é€Ÿ) ---
        let cachedPosition = null;
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    cachedPosition = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    if (map) map.setCenter(cachedPosition);
                },
                (err) => console.log("GPSå¾…å‘½"),
                { enableHighAccuracy: true }
            );
        }

        window.onload = async function() {
            if (GOOGLE_MAPS_API_KEY.includes('YOUR_')) alert('è¨˜å¾—å¡«å…¥ API KEY');
            renderPaymentOptions();
            
            // LIFF Init
            try { await liff.init({ liffId: LIFF_ID }); if (!liff.isLoggedIn()) liff.login(); } 
            catch (e) {}

            loadGoogleMapsScript();
        };

        function loadGoogleMapsScript() {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places&language=zh-TW&callback=initMap`;
            script.async = true; 
            script.defer = true;
            document.head.appendChild(script);
        }

        window.initMap = function() {
            geocoder = new google.maps.Geocoder();
            const startPos = cachedPosition || { lat: 25.0330, lng: 121.5654 };

            map = new google.maps.Map(document.getElementById("map"), {
                center: startPos,
                zoom: 17,
                disableDefaultUI: true,
                clickableIcons: false
            });

            // åˆå§‹åŒ–ä¸‹è»Šåœ°é» Autocomplete (ç¶å®šåœ¨ Step 2 çš„è¼¸å…¥æ¡†)
            initAutocomplete();

            if (!cachedPosition) panToCurrentLocation();
            else {
                geocodePosition(startPos);
                document.getElementById('loading').style.display = 'none';
            }

            // æ‹–æ›³çµæŸå¾ŒåæŸ¥åœ°å€
            map.addListener('dragstart', () => {
                document.getElementById('btn-confirm-pickup').disabled = true;
                document.getElementById('btn-confirm-pickup').classList.add('opacity-50', 'cursor-not-allowed');
                document.getElementById('address-text-step1').innerHTML = '<span class="text-gray-400">å®šä½ä¸­...</span>';
            });
            
            map.addListener('idle', () => {
                geocodePosition(map.getCenter());
            });
        };

        function initAutocomplete() {
            const input = document.getElementById("dropoff-input");
            autocomplete = new google.maps.places.Autocomplete(input, {
                componentRestrictions: { country: "tw" },
                fields: ["formatted_address", "name"],
            });
            
            // ç•¶ä½¿ç”¨è€…é¸å–å»ºè­°åœ°é»æ™‚
            autocomplete.addListener("place_changed", () => {
                const place = autocomplete.getPlace();
                if (!place.name) return; // ä½¿ç”¨è€…æ²’é¸ï¼Œåªæ˜¯äº‚æ‰“
                dropoffLocation.address = place.name; // å„ªå…ˆä½¿ç”¨åœ°é»åç¨± (å¦‚: å°åŒ—è»Šç«™)
            });
        }

        function geocodePosition(pos) {
            const lat = typeof pos.lat === 'function' ? pos.lat() : pos.lat;
            const lng = typeof pos.lng === 'function' ? pos.lng() : pos.lng;

            geocoder.geocode({ location: { lat, lng } }, (results, status) => {
                const btn = document.getElementById('btn-confirm-pickup');
                if (status === "OK" && results[0]) {
                    // åœ°å€ç°¡åŒ–é‚è¼¯
                    let addr = results[0].formatted_address;
                    addr = addr.replace(/^\d+\s*/, '').replace(/å°ç£/, '').replace(/.*?å€/, (match) => match + ' '); 
                    
                    pickupLocation = { lat, lng, address: addr };
                    
                    // æ›´æ–° UI
                    document.getElementById('address-text-step1').innerText = addr;
                    document.getElementById('form-pickup-addr').innerText = addr; // åŒæ­¥æ›´æ–°åˆ°è¡¨å–®
                    
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            });
        }

        // --- æ ¸å¿ƒåˆ‡æ›é‚è¼¯ ---

        function goToStep2() {
            // åˆ‡æ›åˆ°è¡¨å–®å±¤
            document.getElementById('form-layer').classList.add('active');
            // éš±è— Step 1 çš„åº•éƒ¨é¢æ¿
            document.getElementById('bottom-panel-step1').classList.add('hidden-panel');
            // éš±è—å®šä½éˆ•
            document.getElementById('my-loc-btn').classList.add('hidden');
            
            // UX: è‡ªå‹•èšç„¦åˆ°ã€Œä¸‹è»Šåœ°é»ã€è¼¸å…¥æ¡†ï¼Œæ–¹ä¾¿é•·è¼©ç›´æ¥æ‰“å­—
            // setTimeout(() => document.getElementById('dropoff-input').focus(), 400);
        }

        function backToMap() {
            document.getElementById('form-layer').classList.remove('active');
            document.getElementById('bottom-panel-step1').classList.remove('hidden-panel');
            document.getElementById('my-loc-btn').classList.remove('hidden');
        }

        function panToCurrentLocation() {
            document.getElementById('loading').style.display = 'flex';
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        map.panTo({ lat: pos.coords.latitude, lng: pos.coords.longitude });
                        document.getElementById('loading').style.display = 'none';
                    },
                    () => { document.getElementById('loading').style.display = 'none'; }
                );
            }
        }

        // --- ä»˜æ¬¾èˆ‡é€å–® ---

        function renderPaymentOptions() {
            const container = document.getElementById('payment-options');
            container.innerHTML = PAYMENT_METHODS.map(method => `
                <button onclick="selectPayment('${method.id}')" 
                    class="payment-btn ${method.id === selectedPayment ? 'active' : ''} border border-gray-200 rounded-xl p-3 flex flex-col items-center justify-center bg-white transition-all hover:bg-gray-50 relative h-24">
                    <i class="fa-solid ${method.icon} ${method.color} text-2xl mb-2"></i>
                    <span class="text-sm font-bold text-gray-800">${method.label}</span>
                    ${method.sub ? `<span class="text-xs text-gray-400 mt-0.5">${method.sub}</span>` : ''}
                    ${method.id === selectedPayment ? '<div class="absolute top-2 right-2 text-emerald-500"><i class="fa-solid fa-circle-check"></i></div>' : ''}
                </button>
            `).join('');
        }

        function selectPayment(id) {
            selectedPayment = id;
            renderPaymentOptions();
        }

        async function submitOrder() {
            const phone = document.getElementById('user-phone').value;
            // å¦‚æœä½¿ç”¨è€…æ˜¯æ‰‹æ‰“åœ°é»ï¼Œæ²’æœ‰é€é Autocomplete é¸å–ï¼Œæˆ‘å€‘ç›´æ¥æ‹¿è¼¸å…¥æ¡†çš„å€¼
            const manualDropoff = document.getElementById('dropoff-input').value;
            const finalDropoff = manualDropoff || dropoffLocation.address;

            if (!phone || phone.length < 8) { alert('è«‹è¼¸å…¥é›»è©±è™Ÿç¢¼'); return; }
            if (!finalDropoff) { alert('è«‹è¼¸å…¥ä¸‹è»Šåœ°é»'); return; }

            const paymentData = PAYMENT_METHODS.find(p => p.id === selectedPayment);
            const paymentText = paymentData.label + (paymentData.sub || '');
            
            const msg = `ã€ä¸€éµå«è»Šè¨‚å–®ã€‘\n\n` +
                `ğŸ“ é›»è©±ï¼š${phone}\n` +
                `ğŸŸ¢ ä¸Šè»Šï¼š${pickupLocation.address}\n` +
                `ğŸ”´ ä¸‹è»Šï¼š${finalDropoff}\n` +
                `ğŸ’° ä»˜æ¬¾ï¼š${paymentText}\n` +
                `ğŸ•’ æ™‚é–“ï¼šç«‹å³å‡ºç™¼ (VIP)\n\n` +
                `å®šä½é€£çµï¼šhttps://www.google.com/maps/search/?api=1&query=${pickupLocation.lat},${pickupLocation.lng}`;

            if (liff.isInClient()) {
                try {
                    await liff.sendMessages([{ type: 'text', text: msg }]);
                    liff.closeWindow();
                } catch (e) { alert('å‚³é€å¤±æ•—: ' + e); }
            } else {
                alert(msg);
            }
        }
    </script>
</body>
</html>
