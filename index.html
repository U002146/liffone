<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é ç´„å«è»Šæœå‹™</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome for Map Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; overflow: hidden; }
        input, select, textarea { font-size: 17px !important; } 
        .hidden { display: none !important; }
        
        /* --- Map Layer (Step 1) --- */
        #map-layer {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10;
            transition: transform 0.4s ease-in-out;
        }
        #map-layer.slide-out {
            transform: translateY(-100%);
        }
        
        /* Map Center Marker */
        .center-marker {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -100%);
            z-index: 20; pointer-events: none;
            transition: all 0.2s ease;
        }
        .center-marker.lifting { transform: translate(-50%, -130%); }

        /* Map Bottom Panel */
        .bottom-panel-map {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: white; border-radius: 24px 24px 0 0;
            padding: 24px; box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            z-index: 25;
        }

        /* --- Form Layer (Step 2 - Original Form) --- */
        #app {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 5; /* Behind map initially */
            overflow-y: auto;
            background-color: #f3f4f6;
            padding-bottom: 50px; /* Safe area */
            display: none; /* Initially hidden */
        }
        #app.active {
            display: flex; /* Activate flex layout */
        }

        /* Original Form Styles */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em;
            padding-right: 2.5rem; -webkit-appearance: none; -moz-appearance: none; appearance: none;
        }
        ::placeholder { color: #9ca3af; opacity: 1; }
        .swal2-container { z-index: 10000 !important; }
        .location-grid { max-height: 60vh; overflow-y: auto; padding: 4px; }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="loader mb-4 w-12 h-12 border-4 text-emerald-500"></div>
        <p id="loading-text" class="text-gray-500 font-bold text-lg animate-pulse">è¡›æ˜Ÿå®šä½ä¸­...</p>
    </div>

    <!-- ========= STEP 1: åœ°åœ–é¸é»å±¤ (Map Layer) ========= -->
    <div id="map-layer">
        <div id="map" class="w-full h-full"></div>
        
        <!-- ä¸­å¿ƒå¤§é ­é‡ -->
        <div id="center-marker" class="center-marker flex flex-col items-center justify-center">
            <div class="bg-black/80 text-white text-xs font-bold px-3 py-1.5 rounded-full mb-2 shadow-lg backdrop-blur-sm">
                ç§»å‹•åœ°åœ–ä¾†å®šä½
            </div>
            <i class="fa-solid fa-location-dot text-5xl text-emerald-600 drop-shadow-xl"></i>
            <div class="w-4 h-1.5 bg-black/20 rounded-full mt-1 blur-[1.5px]"></div>
        </div>

        <!-- æµ®å‹•å®šä½æŒ‰éˆ• -->
        <button onclick="panToCurrentLocation()" class="absolute bottom-64 right-4 bg-white p-3.5 rounded-full shadow-lg z-30 text-gray-600 active:bg-gray-100 transition-colors">
            <i class="fa-solid fa-location-crosshairs text-xl"></i>
        </button>

        <!-- åº•éƒ¨é¢æ¿ -->
        <div class="bottom-panel-map">
            <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-4"></div>
            <div class="text-center mb-6">
                <p class="text-xs font-bold text-emerald-600 uppercase tracking-wider mb-1">
                    <i class="fa-solid fa-crosshairs mr-1"></i>ä¸Šè»Šåœ°é»
                </p>
                <h2 id="map-address-text" class="text-xl font-bold text-gray-800 leading-snug min-h-[3.5rem] flex items-center justify-center">
                    <span class="text-gray-400">å®šä½ä¸­...</span>
                </h2>
            </div>
            <button id="btn-confirm-map" onclick="confirmMapLocation()" class="w-full bg-emerald-600 text-white font-bold py-4 rounded-xl shadow-lg active:scale-[0.98] transition-transform text-lg flex items-center justify-center space-x-2">
                <span>ç¢ºèªä¸Šè»Šåœ°é»</span>
                <i class="fa-solid fa-arrow-right"></i>
            </button>
        </div>
    </div>


    <!-- ========= STEP 2: ç¶“å…¸é ç´„è¡¨å–® (Form Layer) ========= -->
    <div id="app" class="justify-center p-0 md:p-4">
        <div class="w-full max-w-md bg-white shadow-2xl rounded-none md:rounded-3xl overflow-hidden min-h-screen md:min-h-0 flex flex-col relative">
            
            <!-- Header (Added Back Button) -->
            <header class="bg-blue-600 text-white p-6 pb-8 rounded-b-[2.5rem] shadow-lg z-10 relative">
                <button onclick="backToMap()" class="absolute top-6 left-4 text-white/80 hover:text-white z-50">
                    <i class="fa-solid fa-chevron-left text-xl"></i> é‡é¸åœ°é»
                </button>
                <div class="text-center">
                    <h1 class="text-3xl font-extrabold tracking-wide">ğŸš• é ç´„å«è»Š</h1>
                    <p id="user-display" class="text-blue-100 text-base mt-2 font-medium">è¼‰å…¥ä½¿ç”¨è€…...</p>
                </div>
                <div class="absolute top-0 right-0 -mr-8 -mt-8 w-32 h-32 bg-white opacity-10 rounded-full"></div>
                <div class="absolute bottom-0 left-0 -ml-8 -mb-8 w-24 h-24 bg-white opacity-10 rounded-full"></div>
            </header>

            <!-- Form Container -->
            <div class="flex-1 overflow-y-auto p-6 -mt-6 relative z-20 pb-32">
                <form id="booking-form" class="bg-white rounded-3xl shadow-md border border-gray-100 p-6 space-y-5">
                    <input type="hidden" id="name">
                    
                    <!-- è¯çµ¡é›»è©± -->
                    <div>
                        <label class="block font-bold text-gray-700 mb-2 text-lg">ğŸ“ è¯çµ¡é›»è©±</label>
                        <input type="tel" id="phone" required placeholder="09xx-xxx-xxx" inputmode="tel" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-2xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all text-lg shadow-sm placeholder-gray-400">
                    </div>

                    <!-- æ—¥æœŸèˆ‡æ™‚é–“ -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="relative">
                            <label class="block font-bold text-gray-700 mb-2 text-lg">ğŸ“… æ—¥æœŸ</label>
                            <input type="text" id="date-display" readonly class="w-full p-4 bg-white border border-gray-200 rounded-2xl text-lg shadow-sm focus:ring-2 focus:ring-blue-500 outline-none text-center font-bold text-gray-700">
                            <input type="date" id="date" required onchange="syncDateDisplay()" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer top-8 z-10">
                        </div>
                        <div>
                            <label class="block font-bold text-gray-700 mb-2 text-lg">ğŸ•’ æ™‚é–“</label>
                            <input type="time" id="time" required class="w-full p-4 bg-white border border-gray-200 rounded-2xl text-center text-lg shadow-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                    </div>
                    <div class="text-xs text-center text-gray-400 -mt-2">
                        âš ï¸ å»ºè­°é ç´„ 25 åˆ†é˜å¾Œçš„æ™‚é–“
                    </div>

                    <!-- åœ°é»å€å¡Š -->
                    <div class="border-l-4 border-gray-100 pl-4 space-y-5 py-2">
                        
                        <!-- ä¸Šè»Šåœ°é» (å·²ç”±åœ°åœ–å®šä½) -->
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-lg font-bold text-green-600">ğŸŸ¢ ä¸Šè»Šåœ°é»</label>
                                <!-- ä¿ç•™æŒ‰éˆ•ä½œç‚ºå‚™ç”¨ï¼Œæ”¹åç‚º 'é‡é¸' -->
                                <button type="button" onclick="backToMap()" class="flex items-center space-x-1 px-3 py-1 bg-green-50 text-green-700 text-sm font-bold rounded-full border border-green-200 active:scale-95 transition-transform">
                                    <span>ğŸ“ åœ°åœ–é‡é¸</span>
                                </button>
                            </div>
                            <!-- è¨­ç‚º readonly é˜²æ­¢æ‰‹èª¤æ”¹æ‰ -->
                            <input type="text" id="pickup" required placeholder="åœ°åœ–å®šä½ä¸­..." readonly class="w-full p-4 bg-gray-50 border border-gray-200 rounded-2xl text-lg shadow-sm outline-none text-gray-600 cursor-not-allowed">
                        </div>

                        <!-- ä¸‹è»Šåœ°é» (ä¿ç•™åŸåŠŸèƒ½) -->
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-lg font-bold text-red-600">ğŸ”´ ä¸‹è»Šåœ°é»</label>
                                <button type="button" onclick="openLocationPicker('dropoff')" class="flex items-center space-x-1 px-3 py-1 bg-red-50 text-red-700 text-sm font-bold rounded-full border border-red-200 active:scale-95 transition-transform">
                                    <span>ğŸ“ é¸åœ°é»</span>
                                </button>
                            </div>
                            <input type="text" id="dropoff" required placeholder="è«‹è¼¸å…¥ç›®çš„åœ°" class="w-full p-4 border border-gray-200 rounded-2xl text-lg shadow-sm focus:ring-2 focus:ring-red-500 outline-none placeholder-gray-400">
                        </div>
                    </div>

                    <!-- ä»˜æ¬¾æ–¹å¼ -->
                    <div class="pt-2 border-t border-gray-100">
                        <label class="block font-bold text-gray-700 mb-2 text-lg">ğŸ’° ä»˜æ¬¾æ–¹å¼</label>
                        <select id="payment" class="w-full p-4 bg-yellow-50 border border-yellow-200 rounded-2xl text-lg font-medium text-gray-800 shadow-sm focus:ring-2 focus:ring-yellow-400 outline-none cursor-pointer">
                            <option value="ç¾é‡‘">ğŸ’µ ç¾é‡‘</option>
                            <option value="æ•¬è€å¡">ğŸ§“ æ•¬è€å¡ (65æ­²+)</option>
                            <option value="æ„›å¿ƒå¡">â¤ï¸ æ„›å¿ƒå¡ (èº«éšœ)</option>
                            <option value="ä¹˜è»Šåˆ¸">ğŸ« ä¹˜è»Šåˆ¸</option>
                            <option value="TWRQ">ğŸ“² TWRQ</option>
                            <option value="LINE PAY">ğŸ’³ LINE PAY</option>
                            <option value="APPLE PAY">ğŸ APPLE PAY</option>
                        </select>
                    </div>

                </form>
            </div>

            <!-- Footer Action -->
            <div class="p-6 bg-white border-t border-gray-100 z-30 fixed bottom-0 left-0 right-0 md:absolute">
                <button id="submitBtn" onclick="confirmAndSubmit()" class="w-full py-4 rounded-2xl bg-gradient-to-r from-green-500 to-emerald-600 text-white text-xl font-bold shadow-lg hover:shadow-xl active:scale-[0.98] transition-all flex justify-center items-center">
                    ç¢ºèªé ç´„
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // âš ï¸ API è¨­å®šå€
        const GOOGLE_MAPS_API_KEY = AIzaSyAKIajmzzSO7DHAhvLRMAh3iV-VVUA7cwE'; 
        const MY_LIFF_ID = "2008907691-v0O7W8d3";

        // DOM Elements
        const dom = {
            loading: document.getElementById('loading-overlay'),
            mapLayer: document.getElementById('map-layer'),
            app: document.getElementById('app'),
            userDisplay: document.getElementById('user-display'),
            btn: document.getElementById('submitBtn'),
            mapAddressText: document.getElementById('map-address-text'),
            inputs: {
                name: document.getElementById('name'),
                phone: document.getElementById('phone'),
                date: document.getElementById('date'),
                dateDisplay: document.getElementById('date-display'),
                time: document.getElementById('time'),
                pickup: document.getElementById('pickup'),
                dropoff: document.getElementById('dropoff'),
                payment: document.getElementById('payment')
            }
        };

        const PRESET_LOCATIONS = [
            { name: 'å¸¸ç”¨åœ°å€ A', icon: 'â­', value: 'FAV_ADDR_A' },
            { name: 'å¸¸ç”¨åœ°å€ B', icon: 'â­', value: 'FAV_ADDR_B' },
            { name: 'èŠ±è“®å‰ç«™', icon: 'ğŸš‰' },
            { name: 'èŠ±è“®å¾Œç«™', icon: 'ğŸš‰' },
            { name: 'å‰å®‰è»Šç«™', icon: 'ğŸš‰' },
            { name: 'åŒ—åŸ”è»Šç«™', icon: 'ğŸš‰' },
            { name: 'æ…ˆæ¿Ÿé–€è¨º', icon: 'ğŸ¥' },
            { name: 'æ…ˆæ¿Ÿæ€¥è¨º', icon: 'ğŸ¥' },
            { name: 'é–€è«¾é–€è¨º', icon: 'ğŸ¥' },
            { name: 'é–€è«¾æ€¥è¨º', icon: 'ğŸ¥' },
            { name: 'èŠ±è“®é†«é™¢', icon: 'ğŸ¥' },
            { name: '805é†«é™¢', icon: 'ğŸ¥' },
            { name: 'åœ°æ–¹æ³•é™¢', icon: 'âš–ï¸' },
            { name: 'ç°¡æ˜“æ³•åº­', icon: 'âš–ï¸' },
            { name: 'èŠ±è“®ç¸£æ”¿åºœ', icon: 'ğŸ¢' },
            { name: 'èŠ±è“®å¸‚å…¬æ‰€', icon: 'ğŸ¢' },
            { name: 'æˆ¶æ”¿äº‹å‹™æ‰€', icon: 'ğŸ¢' },
            { name: 'åœ°æ”¿äº‹å‹™æ‰€', icon: 'ğŸ¢' }
        ];

        // Map State
        let map;
        let geocoder;
        let cachedPosition = null;
        let mapPickupAddress = '';

        // --- Initialization ---

        window.onload = function() {
            // 1. Start Pre-fetching GPS (Parallel)
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        cachedPosition = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                        if (map) map.setCenter(cachedPosition);
                    },
                    (err) => console.log("GPS Pending"),
                    { enableHighAccuracy: true }
                );
            }

            // 2. Load Google Maps SDK
            if (GOOGLE_MAPS_API_KEY.includes('YOUR_')) {
                alert('è«‹å¡«å…¥ API KEY');
            } else {
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places&language=zh-TW&callback=initMap`;
                script.async = true; script.defer = true;
                document.head.appendChild(script);
            }

            // 3. Init Form Defaults
            initFormDefaults();

            // 4. Init LIFF
            loadSDK(() => {
                liff.init({ liffId: MY_LIFF_ID }).then(() => {
                    if (!liff.isLoggedIn()) {
                        liff.login();
                        return;
                    }
                    liff.getProfile().then(profile => {
                        dom.userDisplay.innerText = `Hi, ${profile.displayName}`;
                        dom.inputs.name.value = profile.displayName;
                    });
                });
            });
        };

        // --- Map Logic ---

        window.initMap = function() {
            geocoder = new google.maps.Geocoder();
            const startPos = cachedPosition || { lat: 25.0330, lng: 121.5654 };

            map = new google.maps.Map(document.getElementById("map"), {
                center: startPos,
                zoom: 17,
                disableDefaultUI: true,
                clickableIcons: false
            });

            if (!cachedPosition) panToCurrentLocation();
            else {
                geocodePosition(startPos);
                // åªæœ‰ç•¶åœ°åœ–æº–å‚™å¥½ï¼Œæ‰éš±è— Loading
                dom.loading.classList.add('hidden');
            }

            map.addListener('dragstart', () => {
                document.getElementById('btn-confirm-map').disabled = true;
                document.getElementById('btn-confirm-map').classList.add('opacity-50');
                dom.mapAddressText.innerHTML = '<span class="text-gray-400">å®šä½ä¸­...</span>';
            });
            
            map.addListener('idle', () => {
                geocodePosition(map.getCenter());
            });
        };

        function geocodePosition(pos) {
            const lat = typeof pos.lat === 'function' ? pos.lat() : pos.lat;
            const lng = typeof pos.lng === 'function' ? pos.lng() : pos.lng;

            geocoder.geocode({ location: { lat, lng } }, (results, status) => {
                const btn = document.getElementById('btn-confirm-map');
                if (status === "OK" && results[0]) {
                    let addr = results[0].formatted_address;
                    addr = addr.replace(/^\d+\s*/, '').replace(/å°ç£/, '').replace(/.*?å€/, (match) => match + ' '); 
                    
                    mapPickupAddress = addr;
                    dom.mapAddressText.innerText = addr;
                    
                    // è§£é–æŒ‰éˆ•
                    btn.disabled = false;
                    btn.classList.remove('opacity-50');
                    
                    // åŒæ­¥éš±è— Loading (å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è¼‰å…¥)
                    dom.loading.classList.add('hidden');
                }
            });
        }

        function panToCurrentLocation() {
            dom.loading.classList.remove('hidden');
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        map.panTo({ lat: pos.coords.latitude, lng: pos.coords.longitude });
                        dom.loading.classList.add('hidden');
                    },
                    () => { dom.loading.classList.add('hidden'); }
                );
            }
        }

        function confirmMapLocation() {
            // 1. æŠŠåœ°åœ–åœ°å€å¡«å…¥è¡¨å–®
            dom.inputs.pickup.value = mapPickupAddress;
            
            // 2. åˆ‡æ› UIï¼šåœ°åœ–æ»‘å‡ºï¼Œè¡¨å–®é¡¯ç¤º
            dom.mapLayer.classList.add('slide-out');
            dom.app.classList.add('active');
        }

        function backToMap() {
            dom.mapLayer.classList.remove('slide-out');
            dom.app.classList.remove('active');
        }

        // --- Form Logic (Original) ---

        function initFormDefaults() {
            const savedPhone = localStorage.getItem('taxi_user_phone');
            if (savedPhone) {
                dom.inputs.phone.value = (savedPhone.length === 9 && !savedPhone.startsWith('0')) ? '0' + savedPhone : savedPhone;
            }

            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            
            dom.inputs.date.value = `${year}-${month}-${day}`;
            syncDateDisplay();

            // é è¨­ +30 åˆ†
            now.setMinutes(now.getMinutes() + 30);
            dom.inputs.time.value = now.toTimeString().substring(0,5);
        }

        function syncDateDisplay() {
            const val = dom.inputs.date.value;
            if (val) {
                const parts = val.split('-');
                dom.inputs.dateDisplay.value = `${parts[1]}/${parts[2]}`;
            }
        }

        function validateTimeBeforeSubmit() {
            const inputDateStr = dom.inputs.date.value;
            const inputTimeStr = dom.inputs.time.value;
            if (!inputDateStr || !inputTimeStr) return true;

            const selectedDateTime = new Date(`${inputDateStr}T${inputTimeStr}`);
            const now = new Date();
            const minTime = new Date(now.getTime() + 25 * 60 * 1000); 

            if (selectedDateTime < minTime) {
                Swal.fire({
                    icon: 'warning',
                    title: 'æ™‚é–“å¤ªè¶•å›‰ï¼',
                    text: 'ç‚ºäº†ç¢ºä¿å¸æ©Ÿè¶•å¾—åˆ°ï¼Œè«‹é ç´„ 25 åˆ†é˜å¾Œçš„æ™‚é–“ ğŸ™',
                    confirmButtonText: 'å¥½çš„ï¼Œæˆ‘æ”¹ä¸€ä¸‹',
                    confirmButtonColor: '#3b82f6'
                });
                return false;
            }
            return true;
        }

        // Location Picker for Dropoff (and Pickup override)
        let currentTargetInputId = '';
        window.openLocationPicker = function(inputId) {
            currentTargetInputId = inputId;
            let buttonsHtml = '<div class="grid grid-cols-2 gap-3 mt-2 location-grid">';
            PRESET_LOCATIONS.forEach(loc => {
                const val = loc.value !== undefined ? loc.value : loc.name;
                let bgClass = 'bg-gray-50 hover:bg-blue-50';
                if(val === 'FAV_ADDR_A' || val === 'FAV_ADDR_B') bgClass = 'bg-yellow-50 hover:bg-yellow-100 border-yellow-200';

                buttonsHtml += `
                    <button onclick="selectLocation('${val}')" 
                        class="flex flex-col items-center justify-center p-4 border border-gray-200 rounded-xl transition-all active:scale-95 ${bgClass}">
                        <span class="text-2xl mb-1">${loc.icon}</span>
                        <span class="text-base font-bold text-gray-700">${loc.name}</span>
                    </button>
                `;
            });
            buttonsHtml += '</div>';

            Swal.fire({
                title: 'è«‹é¸æ“‡åœ°é»',
                html: buttonsHtml,
                showConfirmButton: false,
                showCloseButton: true,
                customClass: { popup: 'rounded-3xl', content: 'p-0' }
            });
        }

        window.selectLocation = function(value) {
            const input = document.getElementById(currentTargetInputId);
            
            if (value === 'FAV_ADDR_A' || value === 'FAV_ADDR_B') {
                const storageKey = value === 'FAV_ADDR_A' ? 'taxi_fav_addr_a' : 'taxi_fav_addr_b';
                const labelName = value === 'FAV_ADDR_A' ? 'å¸¸ç”¨åœ°å€ A' : 'å¸¸ç”¨åœ°å€ B';

                const savedAddr = localStorage.getItem(storageKey);
                
                if (savedAddr) {
                    Swal.fire({
                        title: `ğŸ“ é€™æ˜¯æ‚¨çš„${labelName}å—ï¼Ÿ`,
                        text: savedAddr,
                        icon: 'question',
                        showDenyButton: true,
                        confirmButtonText: 'æ˜¯çš„ï¼Œå¡«å…¥',
                        denyButtonText: 'ä¸ï¼Œæˆ‘è¦ä¿®æ”¹',
                        confirmButtonColor: '#10b981', 
                        denyButtonColor: '#ef4444',     
                        reverseButtons: true
                    }).then((result) => {
                        if (result.isConfirmed) {
                            input.value = savedAddr;
                        } else if (result.isDenied) {
                            promptSetFavAddress(input, storageKey, labelName);
                        }
                    });
                } else {
                    promptSetFavAddress(input, storageKey, labelName);
                }
                return;
            }

            Swal.close();
            input.value = value;
        };

        function promptSetFavAddress(input, storageKey, labelName) {
            Swal.fire({
                title: `â­ è¨­å®š${labelName}`,
                input: 'text',
                inputLabel: 'è¼¸å…¥ä¸€æ¬¡ï¼Œä»¥å¾Œè‡ªå‹•å¸¶å…¥',
                inputPlaceholder: 'ä¾‹å¦‚ï¼šèŠ±è“®å¸‚ä¸­æ­£è·¯100è™Ÿ',
                showCancelButton: true,
                confirmButtonText: 'å„²å­˜ä¸¦å¡«å…¥',
                cancelButtonText: 'å–æ¶ˆ',
                confirmButtonColor: '#fbbf24'
            }).then((result) => {
                if (result.isConfirmed && result.value) {
                    localStorage.setItem(storageKey, result.value);
                    input.value = result.value;
                    Swal.fire({ icon: 'success', title: 'å·²è¨˜æ†¶ï¼', timer: 1500, showConfirmButton: false });
                }
            });
        }

        // --- Submit Logic (Original) ---

        function getDateForMessage() {
            return dom.inputs.dateDisplay.value; 
        }

        window.confirmAndSubmit = async function() {
            const form = document.getElementById('booking-form');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            if (!validateTimeBeforeSubmit()) return;

            const friendlyDate = getDateForMessage();
            const data = {
                pickup: dom.inputs.pickup.value,
                dropoff: dom.inputs.dropoff.value,
                date: dom.inputs.date.value,
                friendlyDate: friendlyDate,
                time: dom.inputs.time.value,
                name: dom.inputs.name.value,
                phone: dom.inputs.phone.value,
                payment: dom.inputs.payment.value
            };

            const result = await Swal.fire({
                title: 'è«‹ç¢ºèªé ç´„è³‡æ–™',
                html: `
                    <div class="text-left bg-gray-50 p-4 rounded-lg text-sm space-y-2">
                        <p><span class="font-bold text-gray-500">ğŸ“… æ™‚é–“ï¼š</span>${data.friendlyDate} ${data.time}</p>
                        <p><span class="font-bold text-green-600">ğŸŸ¢ ä¸Šè»Šï¼š</span>${data.pickup}</p>
                        <p><span class="font-bold text-red-600">ğŸ”´ ä¸‹è»Šï¼š</span>${data.dropoff}</p>
                        <p><span class="font-bold text-yellow-600">ğŸ’° ä»˜æ¬¾ï¼š</span>${data.payment}</p>
                        <p><span class="font-bold text-gray-500">ğŸ“ é›»è©±ï¼š</span>${data.phone}</p>
                    </div>
                `,
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: 'âœ… ç¢ºèªé ç´„',
                cancelButtonText: 'âŒ ä¿®æ”¹',
                confirmButtonColor: '#10b981',
                cancelButtonColor: '#d1d5db',
                reverseButtons: true
            });

            if (!result.isConfirmed) return;
            executeSubmission(data);
        };

        async function executeSubmission(data) {
            localStorage.setItem('taxi_user_phone', data.phone);

            dom.btn.disabled = true;
            dom.btn.innerHTML = `<div class="loader mr-3"></div> è³‡æ–™å‚³é€ä¸­...`;
            dom.btn.classList.remove('from-green-500', 'to-emerald-600');
            dom.btn.classList.add('bg-gray-400', 'cursor-not-allowed');

            const msgText = `ğŸ—“ï¸ é ç´„å«è»Šç¢ºèªå–®\nğŸ‘¤ ä¹˜å®¢ï¼š${data.name}\nğŸ“ é›»è©±ï¼š${data.phone}\nğŸ“… æ™‚é–“ï¼š${data.friendlyDate} ${data.time}\nğŸ’° ä»˜æ¬¾ï¼š${data.payment}\nğŸŸ¢ ä¸Šè»Šï¼š${data.pickup}\nğŸ”´ ä¸‹è»Šï¼š${data.dropoff}`;

            try {
                if (liff.isInClient()) {
                    await liff.sendMessages([{ type: 'text', text: msgText }]);
                }

                const startDateTime = new Date(`${data.date}T${data.time}`).toISOString().replace(/-|:|\.\d\d\d/g, "");
                const endDateTime = new Date(new Date(`${data.date}T${data.time}`).getTime() + 3600000).toISOString().replace(/-|:|\.\d\d\d/g, "");
                const calTitle = encodeURIComponent(`ğŸš• è¨ˆç¨‹è»Šé ç´„ (${data.pickup} -> ${data.dropoff})`);
                const calDetails = encodeURIComponent(`å¸æ©Ÿé›»è©±ï¼š(è«‹å¾…ç¢ºèª)\nä»˜æ¬¾æ–¹å¼ï¼š${data.payment}`);
                const calLocation = encodeURIComponent(data.pickup);
                const googleCalUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${calTitle}&dates=${startDateTime}/${endDateTime}&details=${calDetails}&location=${calLocation}`;

                Swal.fire({
                    icon: 'success',
                    title: 'é ç´„æˆåŠŸï¼',
                    html: `
                        <p class="mb-4 text-gray-600">å¸æ©Ÿå°‡ç›¡å¿«èˆ‡æ‚¨è¯ç¹«</p>
                        <a href="${googleCalUrl}" target="_blank" class="inline-flex items-center px-4 py-2 bg-blue-100 text-blue-700 rounded-lg font-bold hover:bg-blue-200 transition-colors">
                            ğŸ“… åŠ å…¥è¡Œäº‹æ›†
                        </a>
                    `,
                    confirmButtonText: 'é—œé–‰è¦–çª—',
                    confirmButtonColor: '#10b981'
                }).then(() => {
                    liff.closeWindow();
                });

            } catch (err) {
                console.error(err);
                if (!liff.isInClient()) {
                     alert("è«‹åœ¨ LINE App å…§é–‹å•Ÿæ­¤é é¢ä»¥å‚³é€è¨Šæ¯ã€‚\n\n" + msgText);
                } else {
                     alert("âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š" + err.message);
                }
                
                dom.btn.disabled = false;
                dom.btn.innerHTML = "ç¢ºèªé ç´„";
                dom.btn.classList.add('from-green-500', 'to-emerald-600');
                dom.btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
            }
        }

        function loadSDK(callback) {
            const script = document.createElement('script');
            script.src = 'https://static.line-scdn.net/liff/edge/2/sdk.js';
            script.onload = callback;
            document.head.appendChild(script);
        }
    </script>
</body>
</html>
